<app-task-collection-drawer (load)="loadCollection($event)">
    <app-navigation [showMenu]="false"></app-navigation>

    <div class="max-w-4xl mx-auto p-6 space-y-8 min-h-[calc(100vh-200px)] relative z-10">

        <div class="text-center space-y-2">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                Tasquery
            </h1>
            <p class="text-base-content/60">Turn chaos into structured tasks in seconds.</p>
        </div>

        <div class="card bg-base-100 shadow-xl border border-base-200 overflow-hidden">

            <div class="settings-toolbar bg-base-200/50 border-b border-base-200">

                <div class="join mode-switcher gap-2">
                    <button class="btn btn-sm join-item"
                            [class.btn-neutral]="config().mode === GenerationMode.STANDARD"
                            (click)="toggleMode(GenerationMode.STANDARD)">
                        <lucide-icon [img]="icons.standard" size="16"></lucide-icon>
                        Standard
                    </button>
                    <button class="btn btn-sm join-item"
                            [class.btn-error]="config().mode === GenerationMode.JIRA_BUG"
                            [class.text-white]="config().mode === GenerationMode.JIRA_BUG"
                            (click)="toggleMode(GenerationMode.JIRA_BUG)">
                        <lucide-icon [img]="icons.bug" size="16"></lucide-icon>
                        Jira Bug
                    </button>
                </div>

                <div class="divider divider-horizontal mx-0"></div>

                <label class="toggle-label">
                    <span class="label-text text-xs font-semibold uppercase tracking-wide">Acceptance Criteria</span>
                    <input type="checkbox" class="toggle toggle-sm toggle-success"
                           [checked]="config().includeAcceptanceCriteria"
                           (change)="toggleAcceptanceCriteria()"/>
                </label>
            </div>

            <div class="p-0 relative">
                <textarea
                    class="input-area text-base-content"
                    maxlength="{{ maxBodyLength }}"
                    placeholder="Paste your meeting notes, slack thread, or just brainstorm here..."
                    [ngModel]="inputText()"
                    (ngModelChange)="inputText.set($event)"
                ></textarea>

                <div class="absolute bottom-2 right-4 text-xs text-base-content/40 font-mono">
                    {{ inputText().length }} / {{ maxBodyLength }}
                </div>
            </div>

            <div class="action-footer bg-base-100 border-t border-base-200">
                <div class="dropdown dropdown-top dropdown-hover sample-dropdown pt-2">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-xs text-base-content/60">
                        Try a sample...
                    </div>
                    <ul tabindex="0" class="dropdown-content menu shadow bg-base-100 rounded-box w-52 border border-base-200">
                        @for (s of sampleInputLabels; track s.key) {
                            <li><a (click)="loadSample(s.key)">{{ s.label }}</a></li>
                        }
                    </ul>
                </div>

                <button class="btn btn-primary px-8 transition-all hover:scale-105"
                        [disabled]="!isInputValid() || loading()"
                        (click)="generateTasks()">
                    @if (loading()) {
                        <span class="loading loading-spinner loading-sm"></span>
                        Thinking...
                    } @else {
                        <lucide-icon [img]="icons.send" size="18"></lucide-icon>
                        Generate {{ config().mode === GenerationMode.JIRA_BUG ? 'Bug Report' : 'Tasks' }}
                    }
                </button>
            </div>
        </div>

        @if (error()) {
            <div class="alert alert-error animate__animated animate__fadeIn">
                <lucide-icon [img]="icons.alert"></lucide-icon>
                <span>{{ error() }}</span>
            </div>
        }

        @if (tasks() && tasks().length > 0) {
            <div class="space-y-4 animate__animated animate__fadeInUp">

                <div class="flex flex-wrap justify-between items-center gap-4 p-4 bg-base-100 rounded-xl shadow-sm border border-base-200">

                    <div class="flex flex-col gap-1">
                        @if (activeCollection()) {
                            <div class="flex items-center gap-1 text-xs text-success font-bold tracking-wider uppercase opacity-80">
                                <lucide-icon [img]="icons.cloudCheck" size="14"></lucide-icon>
                                Saved to local storage
                            </div>

                            <div class="flex items-center gap-2 group">
                                <h2 class="text-xl font-bold truncate max-w-xs sm:max-w-md cursor-pointer hover:underline decoration-base-300 underline-offset-4 decoration-2 transition-all"
                                    (click)="renameCollection()"
                                    title="Click to rename">
                                    {{ activeCollection()!.title }}
                                </h2>
                                <button class="btn btn-ghost btn-xs btn-circle opacity-0 group-hover:opacity-100 transition-opacity"
                                        (click)="renameCollection()">
                                    <lucide-icon [img]="icons.edit" size="14"></lucide-icon>
                                </button>
                            </div>
                        } @else {
                            <div class="text-xs text-warning font-bold tracking-wider uppercase opacity-80">
                                Unsaved Draft
                            </div>
                            <h2 class="text-xl font-bold text-base-content/60">New Unsaved Collection</h2>
                        }
                    </div>

                    <div class="flex gap-2">
                        @if (activeCollection()) {
                            <button class="btn btn-outline btn-sm gap-2" (click)="openSaveCollectionModal(true)">
                                <lucide-icon [img]="icons.copy" size="16"></lucide-icon>
                                Duplicate Collection
                            </button>
                        } @else {
                            <button class="btn btn-primary btn-sm gap-2 shadow-sm" (click)="openSaveCollectionModal()">
                                <lucide-icon [img]="icons.save" size="16"></lucide-icon>
                                Save Collection
                            </button>
                        }
                    </div>
                </div>

                @for (task of tasks(); track task.id) {
                    <app-task-card
                        [task]="task"
                        (saveTask)="onSaveTask($event)"
                        (deleteTask)="onDeleteTask($event)"
                    ></app-task-card>
                }
            </div>
        }
    </div>

    @if (activeCollection()) {
        <app-rename-collection-dialog
            #renameCollectionModal
            [collection]="activeCollection()!"
            (saved)="onRenameCollection($event)">
        </app-rename-collection-dialog>
    }

    <app-save-task-collection-dialog
        #saveCollectionModal
        (saved)="saveCollection($event)">
    </app-save-task-collection-dialog>

    <footer class="footer footer-center p-10 text-base-content/50">
        <aside>
            <p>Taskquery Â© {{ year() }}</p>
            <app-terms-of-use></app-terms-of-use>
        </aside>
    </footer>

    <div class="fixed bottom-0 left-0 -z-10 w-64 opacity-50 hidden xl:block">
        <img [ngSrc]="'/taking-notes-2.svg'" width="400" height="600" alt="bg" class="w-full h-auto"/>
    </div>
    <div class="fixed bottom-0 right-0 -z-10 w-64 opacity-50 hidden xl:block">
        <img [ngSrc]="'/content-structure-2.svg'" width="360" height="600" alt="bg" class="w-full h-auto"/>
    </div>
</app-task-collection-drawer>
