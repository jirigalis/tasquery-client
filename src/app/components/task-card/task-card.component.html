<div class="card shadow-xl rounded-2xl animate__animated animate__bounceIn"
     [class.bg-base-100]="!editMode()"
     [class.bg-base-200]="editMode()"
>
    <div class="card-body">

        <!-- Header row -->
        <div class="card-title">
            @if (!editMode()) {
                <div class="task-title">
                    {{ task().title }}
                </div>
                <div class="task-priority">{{ taskPriority() }}</div>
            } @else {
                <input type="text"
                       maxlength="{{ maxTitleLength }}"
                       class="input input-sm input-title"
                       [(ngModel)]="editableTask()!.title"
                       placeholder="Enter title..."/>
                <select class="select select-sm select-priority" [(ngModel)]="editableTask()!.priority">
                    @for (level of priorityLevels; track level) {
                        <option [value]="level" [selected]="level === editableTask()!.priority">
                            {{ level }}
                        </option>
                    }
                </select>
            }
        </div>

        <!-- Labels -->
        <div class="labels-wrapper">
            @if (!editMode()) {
                @for (badge of task().labels; track badge) {
                    <app-badge [label]="badge"></app-badge>
                }
            } @else {
                <input type="text"
                       maxlength="{{ maxLabelsLength }}"
                       class="input input-sm w-full"
                       [(ngModel)]="editableLabels"
                       placeholder="Comma-separated labels"/>
            }
        </div>

        <!-- Body -->
        <div class="task-body">
            @if (!editMode()) {
                <p>{{ task().body }}</p>
            } @else {
                <textarea class="textarea textarea-bordered"
                          maxlength="{{ maxBodyLength }}"
                          [(ngModel)]="editableTask()!.body"
                          placeholder="Enter task description..."></textarea>
                <div class="label ml-auto">
                    {{ editableTask()!.body.length }}/{{ maxBodyLength }}
                </div>
            }
        </div>

        <!-- Actions -->
        <div class="card-actions">

            <!-- Edit / Save toggle -->
            <div class="edit-actions">
                <button class="btn btn-lg sm:btn-sm btn-outline tooltip"
                        (click)="toggleEdit()"
                        [attr.data-tip]="editMode() ? 'Save changes' : 'Edit this task'"
                >
                    <lucide-icon [img]="editMode() ? checkIcon : pencilIcon" size="16"></lucide-icon>
                    <span class="btn-label">{{ editMode() ? 'Save' : 'Edit' }}</span>
                </button>
                @if (editMode()) {
                    <button class="btn btn-lg sm:btn-sm btn-outline btn-error tooltip"
                            (click)="cancelEdit()"
                            data-tip="Cancel editing">
                        <lucide-icon [img]="pencilOffIcon" size="16"></lucide-icon>
                        <span class="btn-label">Cancel</span>
                    </button>
                } @else {
                    <button class="btn btn-lg sm:btn-sm btn-outline btn-error tooltip"
                            (click)="handleDelete()"
                            data-tip="Delete this task">
                        <lucide-icon [img]="trashIcon" size="16"></lucide-icon>
                        <span class="btn-label">Delete</span>
                    </button>
                }
            </div>

            <!-- Export buttons -->
            @if (!editMode()) {
                <div class="export-wrapper">
                    <div class="export-container">
                        <span class="export-label">Export task as:</span>

                        <button class="btn btn-outline btn-sm tooltip"
                                (click)="openExportDialog(task(), 'markdown')"
                                [disabled]="editMode()"
                                data-tip="Export task to Markdown">
                            <lucide-icon [img]="codeXmlIcon" size="16"></lucide-icon>
                            Markdown
                        </button>

                        <button class="btn btn-outline btn-sm tooltip"
                                (click)="openExportDialog(task(), 'json')"
                                [disabled]="editMode()"
                                data-tip="Export task to JSON">
                            <lucide-icon [img]="fileJsonIcon" size="16"></lucide-icon>
                            JSON
                        </button>
                    </div>

                    <span class="export-container-mobile">
                        <div class="fab">
                            <div tabindex="0" role="button" class="btn btn-lg btn-circle btn-outline">
                                <lucide-icon [img]="fileUpIcon" size="24"></lucide-icon>
                            </div>

                            <button class="btn btn-lg btn-primary"
                                    (click)="openExportDialog(task(), 'json')">
                                <lucide-icon [img]="fileJsonIcon" size="16"></lucide-icon>
                                Export to JSON
                            </button>
                            <button class="btn btn-lg btn-primary"
                                    (click)="openExportDialog(task(), 'markdown')">
                                <lucide-icon [img]="codeXmlIcon" size="16"></lucide-icon>
                                Export to Markdown
                            </button>
                        </div>
                    </span>
                </div>
            }
        </div>
    </div>
    <app-export-dialog
        [format]="exportFormat()"
        [content]="convertedTask()"
        (onDownload)="exportToFormat(task())"
    ></app-export-dialog>
</div>

<app-confirm-dialog
    [visible]="confirmVisible()"
    [title]="'Delete Task'"
    [type]="'error'"
    [message]="'This action cannot be undone. Do you want to continue?'"
    (confirm)="onDeleteConfirmed()"
    (cancel)="onDeleteCancelled()"
/>
